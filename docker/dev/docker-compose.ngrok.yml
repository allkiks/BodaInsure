# BodaInsure ngrok Tunnel for M-Pesa Callbacks
#
# This runs separately from the main docker-compose to prevent URL changes
# on container restarts. Start this once and keep it running.
#
# IMPORTANT: This uses a separate project name (bodainsure-ngrok) to avoid
# orphan container warnings when running the main dev stack.
#
# Usage (use Makefile - recommended):
#   make dev-ngrok          Start ngrok tunnel
#   make dev-ngrok-url      Get the ngrok public URL
#   make dev-ngrok-logs     View ngrok logs
#   make dev-ngrok-down     Stop ngrok tunnel
#
# Manual usage (must specify --env-file and -p for project name):
#   docker compose -p bodainsure-ngrok -f docker/dev/docker-compose.ngrok.yml --env-file .env.docker up -d
#   docker compose -p bodainsure-ngrok -f docker/dev/docker-compose.ngrok.yml --env-file .env.docker logs
#   docker compose -p bodainsure-ngrok -f docker/dev/docker-compose.ngrok.yml --env-file .env.docker down
#
# Get your ngrok URL:
#   make dev-ngrok-url
#   OR visit http://localhost:4040
#
# Then update .env.docker with the ngrok URL for MPESA_CALLBACK_URL

name: bodainsure-ngrok

services:
  ngrok:
    image: ngrok/ngrok:latest
    container_name: bodainsure-ngrok-dev
    restart: unless-stopped
    command:
      - "http"
      - "host.docker.internal:3000"
      - "--log=stdout"
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN:?NGROK_AUTHTOKEN is required - get it from https://dashboard.ngrok.com/get-started/your-authtoken}
    ports:
      - "4040:4040"  # ngrok web interface
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - bodainsure-dev-network

networks:
  bodainsure-dev-network:
    external: true
